# >> 三百六十五萬case 經驗紀錄 << #



## 先創造表格再匯入資料避免key重複 ##

先直接用table data import wizard匯入整個csv 再去讀取創表格的格式有時候比較快

```
SHOW CREATE TABLE yoyo.mark_6562_case_originaldata
```

於是複製修改一下 如下

## 先創造表格 讀進365w結構 ##

先直接用table data import wizard匯入整個csv 再去讀取創表格的格式有時候比較快

```
SHOW CREATE TABLE yoyo.temp_import_365
```
### 創表格 ###
設定 PRIMARY KEY 為Canonical_Smiles
 和 UNIQUE KEY 為id 讓他自動編號
複製修改一下 如下
```
CREATE TABLE `3.65M__case_smiles_originaldata` (
 id INT UNSIGNED NOT NULL AUTO_INCREMENT,
 `Original_Smiles` text,
 `Canonical_Smiles` varchar(120) NOT NULL,

 PRIMARY KEY (Canonical_Smiles),
 UNIQUE KEY (id)
 )
 ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```



## 隨機取出2w個 ##
.....

```
CREATE TABLE `3.65M__case_smiles_random_2w`
SELECT * 
FROM `3.65M__case_smiles_originaldata`
ORDER BY RAND()
LIMIT 20000
```



## 取出前1w個 當train data ##
.....

```
CREATE TABLE `3.65M__case_smiles_train_data_1w`
SELECT * 
FROM `3.65M__case_smiles_random_2w`
LIMIT 10000    #前1w筆資料
```


## 取出最後1w個 當validation data ##
.....

```
CREATE TABLE `yoyo.temp_3.65M__case_smiles_validation_data_1w`
SELECT * 
FROM `yoyo.temp_3.65M__case_smiles_random_2w`
LIMIT 10000, 10000   #跳過前1w筆  取接著的1w筆
```


## 改善匯入效率 ##

文件my.ini中的此行設定:
設成0效率最好，但安全方面比較差，即使MySQL掛了也可能會損失當下讀寫的數據。
而值2只會在整個操作系統 掛了時才可能丟失數據。
```
innodb_flush_log_at_trx_commit=0   #實測速度提升2倍
```


以及更改
```
innodb_log_file_size=512MB
innodb_log_buffer_size=16MB
```
### 後來改用load data 指令

先創出表格
```
CREATE TABLE `3.65M__case_smiles_originaldata` (
 id INT UNSIGNED NOT NULL AUTO_INCREMENT,
 `Original_Smiles` text,
 `Canonical_Smiles` varchar(120) NOT NULL,

 PRIMARY KEY (Canonical_Smiles),
 UNIQUE KEY (id)
 )
 ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```
再用指令匯入
```
LOAD DATA INFILE 'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/365w_case/3649051_canonical_smile.csv'
INTO TABLE `3.65M__case_smiles_originaldata`
      FIELDS  TERMINATED BY ',' 
            #  ENCLOSED BY '"' 
      LINES   TERMINATED BY "\r"
(Original_Smiles, Canonical_Smiles)
```


## xxxxx ##
.....

```
.......
```

